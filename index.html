<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
     <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Startups in Nepal - A Directory of Tech Startups in Nepal</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <script src="js/handlebars/handlebars.js"></script>
    <script src="js/tabletop/src/tabletop.js"></script>
    <script src="js/jquery/jquery.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.4.4/angular-route.js"></script>
    <script>

        var spreadsheet_key = "1Ec9Q9CD6MvRSRDtXcg7oIy9F955Llkm2_qcTmfI99Ew";

         // http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
          function shuffle(array) {
              var currentIndex = array.length, temporaryValue, randomIndex;

              // While there remain elements to shuffle...
              while (0 !== currentIndex) {

                  // Pick a remaining element...
                  randomIndex = Math.floor(Math.random() * currentIndex);
                  currentIndex -= 1;

                  // And swap it with the current element.
                  temporaryValue = array[currentIndex];
                  array[currentIndex] = array[randomIndex];
                  array[randomIndex] = temporaryValue;
              }
              return array;
          }

          function numEntries(startup) {
              var count = 0;
              for (key in startup) {
                  if (startup[key] != "") {
                      count++;
                  }
              }
              return count;
          }

          function arrange(data) {
              var hashed = {};

              //Create object of arrays with number of entries as key
              for (var i = 0; i < data.length; i++) {
                  var startup = data[i];
                  var numberOfEntries = numEntries(startup);
                  if (numberOfEntries in hashed) {
                      hashed[numberOfEntries].push(startup);
                  } else {
                      hashed[numberOfEntries] = [];
                      hashed[numberOfEntries].push(startup);
                  }
              }

              //Sort keys in ascending order to give preference to startups who have provided full information
              var entries = Object.keys(hashed);
              entries.sort(function (a, b) { return b - a });

              //Shuffle startups with same number of entries and create final listing
              var startups = [];
              for (i = 0; i < entries.length; i++) {
                  var temp = shuffle(hashed[entries[i]]);
                  startups = startups.concat(temp);
              }

              return startups;
          }

          function redirectTo(productName) {
              return "#/startup/" + urlFriendlyName(productName);
          }

          var urlFriendlyName = function (name) {
              return name.replace(" ", "_");
          }

    </script>
</head>
<body>
    <div class="hero">
        <div class="container">
            
            <div class="center-align column-wrap">
                <img src="images/startupsnepal_logo.png" height="140" />
                <h1>Nepali Startups Directory</h1>
                <a id="add-startup-link" href="http://goo.gl/forms/pcQQAMnXoO">Add Your Startup Here</a>
            </div>
            
           
        </div>
    </div>

    <div class="startups-list">
    </div>


    <script id="startup-template" type="text/x-handlebars-template">
        <div class="box">
            <div class="flip-container" ontouchstart="this.classList.toggle('hover');">
                <div class="flipper">
                    <div class="front center-align">
                        <img src="{{[Logo URL]}}" height="{{#if Height}}{{Height}}{{else}}75{{/if}}" />
                    </div>
                    <a href="{{[Website URL]}}">
                        <div class="back center-align column-wrap">
                            <h2>{{[Product Name]}}</h2>
                            <h5>{{[Product Tagline]}}</h5>
                            <h6>
                                VISIT WEBSITE
                            </h6>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </script>

    <div ng-app="startupsnepal">
        <div ng-view>

        </div>
    </div>

    <script>
        var startupsNepalApp = angular.module('startupsnepal', ['ngRoute']);

        startupsNepalApp.config(['$routeProvider',
          function ($routeProvider) {
              $routeProvider.
                when('/', {
                    templateUrl: 'templates/list.html',
                    controller: 'StartupsListingController'
                }).
                when('/startup/:name', {
                    templateUrl: 'templates/startup.html',
                    controller: 'StartupController'
                }).
                otherwise({
                    redirectTo: '/'
                });
          }]);

        startupsNepalApp.factory('startupsNepalCache', function ($cacheFactory) {
            return $cacheFactory('allStartups');
        });
            
        startupsNepalApp.controller('StartupController', function ($scope, $routeParams, startupsNepalCache) {
            function findStartupByName(haystack, needle) {
                var matches =  haystack.filter(function (obj) {
                    // coerce both obj.id and id to numbers 
                    // for val & type comparison
                    return obj["Product Name"].toLowerCase().indexOf(needle.toLowerCase()) != -1;
                });
                return matches[0];
            }

            var cache = startupsNepalCache.get("allStartups");

            if (cache) {
                $scope.startup = findStartupByName(cache, $routeParams.name.replace("_", " "));
            } else {
                Tabletop.init({
                    key: spreadsheet_key,
                    callback: showStartups,
                    simpleSheet: true
                });
            }

            

            function showStartups(data) {
                var allStartups = arrange(data);
                startupsNepalCache.put("startups", allStartups);
                var currentStartup = $routeParams.name.replace("_", " ");
                $scope.startup = findStartupByName(allStartups, currentStartup);
                $scope.$apply();
                $(".startup-detail-logo").height($(".startup-detail-header").height());
            }
        });

       

        startupsNepalApp.controller('StartupsListingController', function ($scope, startupsNepalCache) {
            $scope.redirectTo = redirectTo;

            $scope.urlFriendlyName = urlFriendlyName;

            var cache = startupsNepalCache.get('allStartups');

            if (cache) {
                $scope.startups = cache;
            } else {
                Tabletop.init({
                    key: spreadsheet_key,
                    callback: showStartups,
                    simpleSheet: true
                });
            }
               

            function showStartups(data) {
                var allStartups = arrange(data);
                startupsNepalCache.put("allStartups", allStartups);
                $scope.startups = allStartups;
                $scope.$apply();
            }
        });
        
    </script>

    <script>

        
    </script>
</body>



</html>
